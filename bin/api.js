!function(e){var r={};function t(a){if(r[a])return r[a].exports;var n=r[a]={i:a,l:!1,exports:{}};return e[a].call(n.exports,n,n.exports,t),n.l=!0,n.exports}t.e=function(){return Promise.resolve()},t.m=e,t.c=r,t.d=function(e,r,a){t.o(e,r)||Object.defineProperty(e,r,{enumerable:!0,get:a})},t.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},t.t=function(e,r){if(1&r&&(e=t(e)),8&r)return e;if(4&r&&"object"==typeof e&&e&&e.__esModule)return e;var a=Object.create(null);if(t.r(a),Object.defineProperty(a,"default",{enumerable:!0,value:e}),2&r&&"string"!=typeof e)for(var n in e)t.d(a,n,function(r){return e[r]}.bind(null,n));return a},t.n=function(e){var r=e&&e.__esModule?function(){return e.default}:function(){return e};return t.d(r,"a",r),r},t.o=function(e,r){return Object.prototype.hasOwnProperty.call(e,r)},t.p="",t.oe=function(e){process.nextTick((function(){throw e}))},t(t.s=25)}([function(e,r){e.exports=require("@babel/runtime/regenerator")},function(e,r){e.exports=require("@babel/runtime/helpers/asyncToGenerator")},function(e,r,t){"use strict";var a,n=t(0),o=t.n(n),i=t(1),s=t.n(i),u=t(3);r.a={verifyToken:(a=s()(o.a.mark((function e(r,t,a){var n,i;return o.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(e.prev=0,(n=t.jwt.decode(r))&&n.userId&&n.sessionId&&!(Math.floor(Date.now()/1e3)>n.exp)){e.next=4;break}return e.abrupt("return",null);case 4:return e.next=6,a.collection("users").findOne({_id:new u.ObjectId(n.userId)});case 6:if((i=e.sent)&&i.active&&i.sessionId===n.sessionId){e.next=9;break}return e.abrupt("return",null);case 9:return e.abrupt("return",i);case 12:return e.prev=12,e.t0=e.catch(0),e.abrupt("return",null);case 15:case"end":return e.stop()}}),e,null,[[0,12]])}))),function(e,r,t){return a.apply(this,arguments)})}},function(e,r){e.exports=require("mongodb")},function(e){e.exports=JSON.parse('{"secret":"79a947c3cbecfb5819b03f21eb00b3180e649bea0c189a7f4ff0bdd10e1fd292","authTokenExpiresIn":"7 days","cookieOptions":{"expires":14,"path":"/","domain":"","secure":false,"sameSite":"strict"},"mongo":{"url":"mongodb://localhost:27017","dbName":"zoia"},"apiServer":{"ip":"127.0.0.1","port":3000},"webServer":{"ip":"127.0.0.1","port":3001},"originCORS":"*","trustProxy":true,"development":false,"loglevel":"info"}')},function(e,r){e.exports=require("fs-extra")},function(e,r){e.exports=require("pino")},function(e,r){e.exports=require("ajv")},function(e,r){e.exports=require("uuid/v1")},function(e,r){e.exports=require("crypto")},function(e,r){e.exports=require("jimp")},function(e,r){e.exports=require("fastify-mongodb")},function(e,r){e.exports=require("fastify-url-data")},function(e,r){e.exports=require("fastify-cors")},function(e,r){e.exports=require("fastify-jwt")},function(e,r){e.exports=require("fastify-formbody")},function(e,r){e.exports=require("fastify-multipart")},function(e){e.exports=JSON.parse('{"admin":{"id":"admin","icon":"","admin":false,"adminRoute":"/admin/users"},"pages":{"id":"pages","icon":"file-text","admin":true,"adminRoute":"/admin/pages"},"registry":{"id":"registry","icon":"","admin":false,"adminRoute":""},"users":{"id":"users","icon":"users","admin":true,"adminRoute":"/admin/users"}}')},function(e,r){e.exports=require("fastify")},function(e,r){e.exports=require("@babel/runtime/helpers/toConsumableArray")},function(e,r){e.exports=require("@babel/runtime/helpers/defineProperty")},function(e,r,t){var a={"./admin/api/index.js":[22,0],"./pages/api/index.js":[23,0],"./registry/api/index.js":[26,0],"./users/api/index.js":[24,0]};function n(e){if(!t.o(a,e))return Promise.resolve().then((function(){var r=new Error("Cannot find module '"+e+"'");throw r.code="MODULE_NOT_FOUND",r}));var r=a[e],n=r[0];return t.e(r[1]).then((function(){return t(n)}))}n.keys=function(){return Object.keys(a)},n.id=21,e.exports=n},function(e,r,t){"use strict";t.r(r),r.default=function(){}},function(e,r,t){"use strict";t.r(r);var a=t(0),n=t.n(a),o=t(1),i=t.n(o),s=t(3),u=t(2),d=t(7),c=t.n(d),p=t(5),l=t.n(p),f=l.a.readJSONSync("".concat(__dirname,"/../etc/site.json")),g=(new c.a).compile({type:"object",properties:{path:{type:"string",maxLength:128},filename:{type:"string",maxLength:128}},required:["path","filename"]}),y=t(19),h=t.n(y),m=l.a.readJSONSync("".concat(__dirname,"/../etc/config.json")),b=l.a.readJSONSync("".concat(__dirname,"/../etc/site.json")),v=["title","path"],x=function e(r,t){r.forEach((function(r,a,n){t(r,a,n),r.children&&e(r.children,t)}))},O=function e(r,t){r.forEach((function(r,a,n){t(r,a,n),r.children&&e(r.children,t)}))},k=t(8),q=t.n(k),S=t(10),D=t.n(S);r.default=function(e){var r;e.post("/api/page/view",{schema:{body:{type:"object",properties:{token:{type:"string"},path:{type:"string"},language:{type:"string",minLength:2,maxLength:2}},required:["path","language"]}},attachValidation:!0,handler:(r=i()(n.a.mark((function e(r,t){var a,o,i,s,u,d;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:if(!r.validationError){e.next=3;break}return r.log.error({ip:r.ip,path:r.urlData().path,query:r.urlData().query,error:r.validationError.message}),e.abrupt("return",t.code(400).send(JSON.stringify(r.validationError)));case 3:return e.prev=3,a=r.body.path.toLowerCase().replace(/\/$/,"")||null,o="",i="",a&&(o=a.split(/\//).filter((function(e){return e.length}))).length&&(i=o.pop()),s={$or:[{path:"/".concat((o||[]).join("/")),filename:i},{path:a,filename:""}]},(u={projection:{_id:1,path:1,filename:1}}).projection["data.".concat(r.body.language)]=1,e.next=13,this.mongo.db.collection("pages").findOne(s,u);case 13:if(d=e.sent){e.next=16;break}return e.abrupt("return",t.code(200).send(JSON.stringify({statusCode:404,error:"Page not found"})));case 16:return e.abrupt("return",t.code(200).send(JSON.stringify({statusCode:200,page:d})));case 19:return e.prev=19,e.t0=e.catch(3),r.log.error({ip:r.ip,path:r.urlData().path,query:r.urlData().query,error:e.t0}),e.abrupt("return",t.code(500).send(JSON.stringify({statusCode:500,error:"Internal server error",message:e.t0.message})));case 23:case"end":return e.stop()}}),e,this,[[3,19]])}))),function(e,t){return r.apply(this,arguments)})}),e.post("/api/pages/list",function(e){return{schema:{body:{type:"object",properties:{token:{type:"string"},page:{type:"integer",minimum:1,maximum:999999999},search:{type:"string",maxLength:64},sortColumn:{type:"string",pattern:"^(".concat(v.join("|"),")$")},sortDirection:{type:"string",pattern:"^(asc|desc)$"},language:{type:"string",pattern:"^(".concat(Object.keys(b.languages).join("|"),")$")}},required:["token","page","sortColumn","sortDirection","language"]}},attachValidation:!0,handler:(r=i()(n.a.mark((function r(t,a){var o,i,s,d,c;return n.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!t.validationError){r.next=3;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:t.validationError.message}),r.abrupt("return",a.code(400).send(JSON.stringify(t.validationError)));case 3:return r.next=5,u.a.verifyToken(t.body.token,e,this.mongo.db);case 5:if((o=r.sent)&&o.admin){r.next=9;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:"Authentication failed"}),r.abrupt("return",a.code(403).send(JSON.stringify({statusCode:403,error:"Authentication failed"})));case 9:return r.prev=9,i={sort:{}},s={},t.body.search&&(s.$or=[].concat(h()(Object.keys(b.languages).map((function(e){var r={};return r["data.".concat(e,".title")]={$regex:t.body.search,$options:"i"},r}))),[{path:{$regex:t.body.search,$options:"i"}},{filename:{$regex:t.body.search,$options:"i"}}])),r.next=15,this.mongo.db.collection("pages").find(s,i).count();case 15:return d=r.sent,i.limit=m.commonItemsLimit,i.skip=(t.body.page-1)*m.commonItemsLimit,i.projection={_id:1,path:1,filename:1},Object.keys(b.languages).map((function(e){return i.projection["data.".concat(e,".title")]=1})),i.sort[t.body.sortColumn]="asc"===t.body.sortDirection?1:-1,"path"===t.body.sortColumn&&(i.sort.filename="asc"===t.body.sortDirection?1:-1),r.next=24,this.mongo.db.collection("pages").find(s,i).toArray();case 24:if(r.t0=r.sent,r.t0){r.next=27;break}r.t0=[];case 27:return r.t1=function(e){var r={_id:e._id,path:"".concat("/"===e.path?"":e.path).concat(e.filename?"/".concat(e.filename):"")||"/"},a=Object.keys(b.languages)[0];return r.title=e.data[t.body.language]&&e.data[t.body.language].title?e.data[t.body.language].title:e.data[a]?e.data[a].title:"",r},c=r.t0.map(r.t1),r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:200,items:c,total:d})));case 32:return r.prev=32,r.t2=r.catch(9),t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:r.t2}),r.abrupt("return",a.code(500).send(JSON.stringify({statusCode:500,error:"Internal server error",message:r.t2.message})));case 36:case"end":return r.stop()}}),r,this,[[9,32]])}))),function(e,t){return r.apply(this,arguments)})};var r}(e)),e.post("/api/pages/load",function(e){return{schema:{body:{type:"object",properties:{token:{type:"string"},id:{type:"string",minLength:24,maxLength:24,pattern:"^[a-f0-9]+$"}},required:["token","id"]}},attachValidation:!0,handler:(r=i()(n.a.mark((function r(t,a){var o,i;return n.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!t.validationError){r.next=3;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:t.validationError.message}),r.abrupt("return",a.code(400).send(JSON.stringify(t.validationError)));case 3:return r.next=5,u.a.verifyToken(t.body.token,e,this.mongo.db);case 5:if((o=r.sent)&&o.admin){r.next=9;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:"Authentication failed"}),r.abrupt("return",a.code(403).send(JSON.stringify({statusCode:403,error:"Authentication failed"})));case 9:return r.prev=9,r.next=12,this.mongo.db.collection("pages").findOne({_id:new s.ObjectId(t.body.id)});case 12:if(i=r.sent){r.next=15;break}return r.abrupt("return",a.code(400).send(JSON.stringify({statusCode:400,error:"Non-existent record"})));case 15:return Object.keys(i.data).map((function(e){return i[e]=i.data[e]})),delete i.data,r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:200,data:i})));case 20:return r.prev=20,r.t0=r.catch(9),t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:r.t0}),r.abrupt("return",a.code(500).send(JSON.stringify({statusCode:500,error:"Internal server error",message:r.t0.message})));case 24:case"end":return r.stop()}}),r,this,[[9,20]])}))),function(e,t){return r.apply(this,arguments)})};var r}(e)),e.post("/api/pages/save",function(e){return{schema:{body:{type:"object",properties:{__form_data:{type:"string"}},required:["__form_data"]}},attachValidation:!0,handler:(r=i()(n.a.mark((function r(t,a){var o,i,d,c,p,l,y,h,m,b;return n.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!t.validationError){r.next=3;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:t.validationError.message}),r.abrupt("return",a.code(400).send(JSON.stringify(t.validationError)));case 3:if(r.prev=3,o=JSON.parse(t.body.__form_data),(i=g(o))&&(!o.id||"string"==typeof o.id&&o.id.match(/^[a-f0-9]+$/))){r.next=10;break}return d={form:i?null:g.errors||{error:"General validation error"}},t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:d}),r.abrupt("return",a.code(400).send(JSON.stringify({statusCode:400,error:d})));case 10:return c=o.id||null,r.next=13,u.a.verifyToken(o.token,e,this.mongo.db);case 13:if((p=r.sent)&&p.admin){r.next=17;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:"Authentication failed"}),r.abrupt("return",a.code(403).send(JSON.stringify({statusCode:403,error:"Authentication failed"})));case 17:if(!c){r.next=23;break}return r.next=20,this.mongo.db.collection("pages").findOne({_id:new s.ObjectId(c)});case 20:if(r.sent){r.next=23;break}return r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:400,error:"Page not found"})));case 23:return l={filename:o.filename,path:o.path,data:{}},y=l.path.split(/\//).slice(0,-1).join("/")||"/",h=l.path.split(/\//).pop()||"",m={$or:[{path:l.path,filename:l.filename}]},l.filename&&m.$or.push({path:"".concat(l.path,"/").concat(l.filename),filename:""}),h&&!l.filename&&m.$or.push({path:y,filename:h}),c&&(m._id={$ne:new s.ObjectId(c)}),r.next=32,this.mongo.db.collection("pages").findOne(m);case 32:if(!r.sent){r.next=35;break}return r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:400,errorCode:1,error:"Page with such path or filename already exists"})));case 35:return Object.keys(f.languages).map((function(e){o[e]&&(l.data[e]={title:o[e].title,content:o[e].content})})),r.next=38,this.mongo.db.collection("pages").updateOne(c?{_id:new s.ObjectId(c)}:{filename:l.filename,path:l.path},{$set:l},{upsert:!0});case 38:if((b=r.sent)&&b.result&&b.result.ok){r.next=41;break}return r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:400,error:"Cannot update page record"})));case 41:return r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:200})));case 44:return r.prev=44,r.t0=r.catch(3),t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:r.t0}),r.abrupt("return",a.code(500).send(JSON.stringify({statusCode:500,error:"Internal server error",message:r.t0.message})));case 48:case"end":return r.stop()}}),r,this,[[3,44]])}))),function(e,t){return r.apply(this,arguments)})};var r}(e)),e.post("/api/pages/folders/load",function(e){return{schema:{body:{type:"object",properties:{token:{type:"string"},language:{type:"string",minLength:2,maxLength:2}},required:["token","language"]}},attachValidation:!0,handler:(r=i()(n.a.mark((function r(t,a){var o,i,s;return n.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!t.validationError){r.next=3;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:t.validationError.message}),r.abrupt("return",a.code(400).send(JSON.stringify(t.validationError)));case 3:return r.next=5,u.a.verifyToken(t.body.token,e,this.mongo.db);case 5:if((o=r.sent)&&o.admin){r.next=9;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:"Authentication failed"}),r.abrupt("return",a.code(403).send(JSON.stringify({statusCode:403,error:"Authentication failed"})));case 9:return r.prev=9,r.next=12,this.mongo.db.collection("registry").findOne({_id:"pages_folder_tree"});case 12:return i=r.sent,s=i&&i.data||[],x(s,(function(e){var r=e.data[Object.keys(e.data)[0]].title,a=e.data[t.body.language]&&e.data[t.body.language].title||r;e.title=a})),r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:200,data:s})));case 18:return r.prev=18,r.t0=r.catch(9),t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:r.t0}),r.abrupt("return",a.code(500).send(JSON.stringify({statusCode:500,error:"Internal server error",message:r.t0.message})));case 22:case"end":return r.stop()}}),r,this,[[9,18]])}))),function(e,t){return r.apply(this,arguments)})};var r}(e)),e.post("/api/pages/folders/save",function(e){return{schema:{body:{type:"object",properties:{token:{type:"string"},folders:{type:"array"}},required:["token","folders"]}},attachValidation:!0,handler:(r=i()(n.a.mark((function r(t,a){var o,i;return n.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!t.validationError){r.next=3;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:t.validationError.message}),r.abrupt("return",a.code(400).send(JSON.stringify(t.validationError)));case 3:return r.next=5,u.a.verifyToken(t.body.token,e,this.mongo.db);case 5:if((o=r.sent)&&o.admin){r.next=9;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:"Authentication failed"}),r.abrupt("return",a.code(403).send(JSON.stringify({statusCode:403,error:"Authentication failed"})));case 9:return r.prev=9,O(t.body.folders,(function(e){return delete e.title})),r.next=13,this.mongo.db.collection("registry").updateOne({_id:"pages_folder_tree"},{$set:{data:t.body.folders}},{upsert:!0});case 13:if((i=r.sent)&&i.result&&i.result.ok){r.next=16;break}return r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:400,error:"Cannot update database record"})));case 16:return r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:200})));case 19:return r.prev=19,r.t0=r.catch(9),t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:r.t0}),r.abrupt("return",a.code(500).send(JSON.stringify({statusCode:500,error:"Internal server error",message:r.t0.message})));case 23:case"end":return r.stop()}}),r,this,[[9,19]])}))),function(e,t){return r.apply(this,arguments)})};var r}(e)),e.post("/api/pages/image/upload",function(e){return{handler:(r=i()(n.a.mark((function r(t,a){var o,i,s,d;return n.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(t.body.token&&t.body.upload&&Array.isArray(t.body.upload)&&"string"==typeof t.body.token){r.next=3;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:"Missing token or file upload"}),r.abrupt("return",a.code(400).send(JSON.stringify({statusCode:400,error:"Missing token or file upload"})));case 3:return r.next=5,u.a.verifyToken(t.body.token,e,this.mongo.db);case 5:if((o=r.sent)&&o.admin){r.next=9;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:"Authentication failed"}),r.abrupt("return",a.code(403).send(JSON.stringify({statusCode:403,error:"Authentication failed"})));case 9:return r.prev=9,r.next=12,l.a.ensureDir("".concat(__dirname,"/../static/uploads"));case 12:return i=q()(),r.next=15,D.a.read(t.body.upload[0].data);case 15:return s=r.sent,r.next=18,s.getBufferAsync(D.a.MIME_JPEG);case 18:return d=r.sent,r.next=21,l.a.writeFile("".concat(__dirname,"/../static/uploads/").concat(i,".jpg"),d);case 21:return r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:200,url:"/uploads/".concat(i,".jpg")})));case 24:return r.prev=24,r.t0=r.catch(9),t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:r.t0}),r.abrupt("return",a.code(500).send(JSON.stringify({statusCode:500,error:"Internal server error",message:r.t0.message})));case 28:case"end":return r.stop()}}),r,this,[[9,24]])}))),function(e,t){return r.apply(this,arguments)})};var r}(e))}},function(e,r,t){"use strict";t.r(r);var a=t(0),n=t.n(a),o=t(1),i=t.n(o),s=t(9),u=t.n(s),d=t(8),c=t.n(d),p=t(4),l=t(2),f=t(5),g=t.n(f).a.readJSONSync("".concat(__dirname,"/../etc/config.json")),y=["username","email","active"],h=["username","email"],m=t(3),b=["username","email","active"],v=["username","email"],x=t(20),O=t.n(x),k=t(7);function q(e,r){var t=Object.keys(e);if(Object.getOwnPropertySymbols){var a=Object.getOwnPropertySymbols(e);r&&(a=a.filter((function(r){return Object.getOwnPropertyDescriptor(e,r).enumerable}))),t.push.apply(t,a)}return t}function S(e){for(var r=1;r<arguments.length;r++){var t=null!=arguments[r]?arguments[r]:{};r%2?q(t,!0).forEach((function(r){O()(e,r,t[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(t)):q(t).forEach((function(r){Object.defineProperty(e,r,Object.getOwnPropertyDescriptor(t,r))}))}return e}var D=new(t.n(k).a),N=D.compile({type:"object",properties:{token:{type:"string"},id:{type:"string"}},required:["token"]}),w=D.compile({type:"object",properties:{username:{type:"string",minLength:4,maxLength:32,pattern:"^[a-zA-Z0-9_-]+$"},password:{type:"string"},email:{type:"string",minLength:6,maxLength:129,pattern:"^(?:[a-zA-Z0-9.!#$%&'*+\\/=?^_`{|}~-])+@(?:[a-zA-Z0-9]|[^\\u0000-\\u007F])(?:(?:[a-zA-Z0-9-]|[^\\u0000-\\u007F]){0,61}(?:[a-zA-Z0-9]|[^\\u0000-\\u007F]))?(?:\\.(?:[a-zA-Z0-9]|[^\\u0000-\\u007F])(?:(?:[a-zA-Z0-9-]|[^\\u0000-\\u007F]){0,61}(?:[a-zA-Z0-9]|[^\\u0000-\\u007F]))?)*$"},active:{type:"string",pattern:"^(0|1)$"},admin:{type:"string",pattern:"^(0|1)$"}},required:["username","email","active","admin"]});r.default=function(e){e.post("/api/users/login",function(e){return{schema:{body:{type:"object",properties:{username:{type:"string",minLength:4,maxLength:32,pattern:"^[a-zA-Z0-9_-]+$"},password:{type:"string",minLength:8,maxLength:64}},required:["username","password"]}},attachValidation:!0,handler:(r=i()(n.a.mark((function r(t,a){var o,i,s,d,l;return n.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!t.validationError){r.next=3;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:t.validationError.message}),r.abrupt("return",a.code(400).send(JSON.stringify(t.validationError)));case 3:return r.prev=3,o=u.a.createHmac("sha512",p.secret).update(t.body.password).digest("hex"),r.next=7,this.mongo.db.collection("users").findOne({username:t.body.username});case 7:if((i=r.sent)&&i.password===o){r.next=10;break}return r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:403,message:"User not found or invalid password",errors:{default:{username:"",password:""}}})));case 10:return s=i.sessionId||c()(),d=String(i._id),l=e.jwt.sign({userId:d,sessionId:s},{expiresIn:p.authTokenExpiresIn}),r.next=15,this.mongo.db.collection("users").updateOne({_id:i._id},{$set:{sessionId:s}});case 15:return r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:200,token:l,user:{username:i.username,id:String(i._id)}})));case 18:return r.prev=18,r.t0=r.catch(3),t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:r.t0}),r.abrupt("return",a.code(500).send(JSON.stringify({statusCode:500,error:"Internal server error",message:r.t0.message})));case 22:case"end":return r.stop()}}),r,this,[[3,18]])}))),function(e,t){return r.apply(this,arguments)})};var r}(e)),e.post("/api/users/logout",function(e){return{schema:{body:{type:"object",properties:{token:{type:"string"}},required:["token"]}},attachValidation:!0,handler:(r=i()(n.a.mark((function r(t,a){var o;return n.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!t.validationError){r.next=3;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:t.validationError.message}),r.abrupt("return",a.code(400).send(JSON.stringify(t.validationError)));case 3:return r.next=5,l.a.verifyToken(t.body.token,e,this.mongo.db);case 5:if(o=r.sent){r.next=9;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:"Authentication failed"}),r.abrupt("return",a.code(403).send(JSON.stringify({statusCode:403,error:"Authentication failed"})));case 9:return r.prev=9,r.next=12,this.mongo.db.collection("users").updateOne({_id:o._id},{$set:{sessionId:null}});case 12:return r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:200})));case 15:return r.prev=15,r.t0=r.catch(9),t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:r.t0}),r.abrupt("return",a.code(500).send(JSON.stringify({statusCode:500,error:"Internal server error",message:r.t0.message})));case 19:case"end":return r.stop()}}),r,this,[[9,15]])}))),function(e,t){return r.apply(this,arguments)})};var r}(e)),e.post("/api/users/list",function(e){return{schema:{body:{type:"object",properties:{token:{type:"string"},page:{type:"integer",minimum:1,maximum:999999999},search:{type:"string",maxLength:64},sortColumn:{type:"string",pattern:"^(".concat(y.join("|"),")$")},sortDirection:{type:"string",pattern:"^(asc|desc)$"}},required:["token","page","sortColumn","sortDirection"]}},attachValidation:!0,handler:(r=i()(n.a.mark((function r(t,a){var o,i,s,u,d;return n.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!t.validationError){r.next=3;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:t.validationError.message}),r.abrupt("return",a.code(400).send(JSON.stringify(t.validationError)));case 3:return r.next=5,l.a.verifyToken(t.body.token,e,this.mongo.db);case 5:if((o=r.sent)&&o.admin){r.next=9;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:"Authentication failed"}),r.abrupt("return",a.code(403).send(JSON.stringify({statusCode:403,error:"Authentication failed"})));case 9:return r.prev=9,i={sort:{}},s={},t.body.search&&(s.$or=h.map((function(e){var r={};return r[e]={$regex:t.body.search,$options:"i"},r}))),r.next=15,this.mongo.db.collection("users").find(s,i).count();case 15:return u=r.sent,i.limit=g.commonItemsLimit,i.skip=(t.body.page-1)*g.commonItemsLimit,i.projection={_id:1,username:1,email:1,active:1},i.sort[t.body.sortColumn]="asc"===t.body.sortDirection?1:-1,r.next=22,this.mongo.db.collection("users").find(s,i).toArray();case 22:return d=r.sent,r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:200,items:d,total:u})));case 26:return r.prev=26,r.t0=r.catch(9),t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:r.t0}),r.abrupt("return",a.code(500).send(JSON.stringify({statusCode:500,error:"Internal server error",message:r.t0.message})));case 30:case"end":return r.stop()}}),r,this,[[9,26]])}))),function(e,t){return r.apply(this,arguments)})};var r}(e)),e.post("/api/users/save/field",function(e){return{schema:{body:{type:"object",properties:{token:{type:"string"},columnId:{type:"string",pattern:"^(".concat(b.join("|"),")$")},recordId:{type:"string",minLength:24,maxLength:24,pattern:"^[a-f0-9]+$"},value:{type:"string",minLength:0,maxLength:128}},required:["token","columnId","recordId"]}},attachValidation:!0,handler:(r=i()(n.a.mark((function r(t,a){var o,i,s,u,d,c;return n.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!t.validationError){r.next=3;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:t.validationError.message}),r.abrupt("return",a.code(400).send(JSON.stringify(t.validationError)));case 3:return o=t.body.value||"",r.next=6,l.a.verifyToken(t.body.token,e,this.mongo.db);case 6:if((i=r.sent)&&i.admin){r.next=10;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:"Authentication failed"}),r.abrupt("return",a.code(403).send(JSON.stringify({statusCode:403,error:"Authentication failed"})));case 10:return r.prev=10,r.next=13,this.mongo.db.collection("users").findOne({_id:new m.ObjectId(t.body.recordId)});case 13:if(s=r.sent){r.next=16;break}return r.abrupt("return",a.code(400).send(JSON.stringify({statusCode:400,error:"Non-existent record"})));case 16:r.t0=t.body.columnId,r.next="username"===r.t0?19:"email"===r.t0?22:"active"===r.t0?25:28;break;case 19:return(u=!o||!o.match(/^[a-z0-9_-]{4,32}$/i))||(o=o.toLowerCase()),r.abrupt("break",30);case 22:return(u=!o||!o.match(/^(?:[a-zA-Z0-9.!#$%&'*+\/=?^_`{|}~-])+@(?:[a-zA-Z0-9]|[^\u0000-\u007F])(?:(?:[a-zA-Z0-9-]|[^\u0000-\u007F]){0,61}(?:[a-zA-Z0-9]|[^\u0000-\u007F]))?(?:\.(?:[a-zA-Z0-9]|[^\u0000-\u007F])(?:(?:[a-zA-Z0-9-]|[^\u0000-\u007F]){0,61}(?:[a-zA-Z0-9]|[^\u0000-\u007F]))?)*$/))||(o=o.toLowerCase()),r.abrupt("break",30);case 25:return(u=!o.match(/^(0|1)$/))||(o=parseInt(o,10)),r.abrupt("break",30);case 28:return u=!1,r.abrupt("break",30);case 30:if(!u){r.next=32;break}return r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:400,errorCode:2,errorField:t.body.columnId,error:"Invalid format"})));case 32:if(-1===v.indexOf(t.body.columnId)||s[t.body.columnId]===o){r.next=40;break}return(d={})[t.body.columnId]=o,r.next=37,this.mongo.db.collection("users").findOne(d);case 37:if(!r.sent){r.next=40;break}return r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:400,errorCode:1,error:"Duplicate value"})));case 40:return s[t.body.columnId]!==o&&((c={})[t.body.columnId]=o,this.mongo.db.collection("users").updateOne({_id:new m.ObjectId(t.body.recordId)},{$set:c})),r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:200,value:o})));case 44:return r.prev=44,r.t1=r.catch(10),t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:r.t1}),r.abrupt("return",a.code(500).send(JSON.stringify({statusCode:500,error:"Internal server error",message:r.t1.message})));case 48:case"end":return r.stop()}}),r,this,[[10,44]])}))),function(e,t){return r.apply(this,arguments)})};var r}(e)),e.post("/api/users/load",function(e){return{schema:{body:{type:"object",properties:{token:{type:"string"},id:{type:"string",minLength:24,maxLength:24,pattern:"^[a-f0-9]+$"}},required:["token","id"]}},attachValidation:!0,handler:(r=i()(n.a.mark((function r(t,a){var o,i;return n.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!t.validationError){r.next=3;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:t.validationError.message}),r.abrupt("return",a.code(400).send(JSON.stringify(t.validationError)));case 3:return r.next=5,l.a.verifyToken(t.body.token,e,this.mongo.db);case 5:if((o=r.sent)&&o.admin){r.next=9;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:"Authentication failed"}),r.abrupt("return",a.code(403).send(JSON.stringify({statusCode:403,error:"Authentication failed"})));case 9:return r.prev=9,r.next=12,this.mongo.db.collection("users").findOne({_id:new m.ObjectId(t.body.id)});case 12:if(i=r.sent){r.next=15;break}return r.abrupt("return",a.code(400).send(JSON.stringify({statusCode:400,error:"Non-existent record"})));case 15:return delete i.password,r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:200,data:{default:{username:i.username,email:i.email,active:i.active?"1":"0",admin:i.admin?"1":"0"}}})));case 19:return r.prev=19,r.t0=r.catch(9),t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:r.t0}),r.abrupt("return",a.code(500).send(JSON.stringify({statusCode:500,error:"Internal server error",message:r.t0.message})));case 23:case"end":return r.stop()}}),r,this,[[9,19]])}))),function(e,t){return r.apply(this,arguments)})};var r}(e)),e.post("/api/users/save",function(e){return{schema:{body:{type:"object",properties:{__form_data:{type:"string"}},required:["__form_data"]}},attachValidation:!0,handler:(r=i()(n.a.mark((function r(t,a){var o,i,s,d,c,f,g,y,h;return n.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!t.validationError){r.next=3;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:t.validationError.message}),r.abrupt("return",a.code(400).send(JSON.stringify(t.validationError)));case 3:if(r.prev=3,o=JSON.parse(t.body.__form_data),i=N(o),s=w(o.default),i&&s&&(!o.id||24===o.id.length&&o.id.match(/^[a-f0-9]+$/))){r.next=11;break}return d={base:i?void 0:N.errors||{error:"General validation error"},form:s?null:w.errors||{error:"General validation error"}},t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:d}),r.abrupt("return",a.code(400).send(JSON.stringify({statusCode:400,error:d})));case 11:return o.default.active=parseInt(o.default.active,10),o.default.admin=parseInt(o.default.admin,10),r.next=15,l.a.verifyToken(o.token,e,this.mongo.db);case 15:if((c=r.sent)&&c.admin){r.next=19;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:"Authentication failed"}),r.abrupt("return",a.code(403).send(JSON.stringify({statusCode:403,error:"Authentication failed"})));case 19:if(f={},o.id||o.default.password){r.next=22;break}return r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:400,errors:{default:{password:"Required"}}})));case 22:if(!o.default.password){r.next=26;break}if(!(o.default.password.length<8)){r.next=25;break}return r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:400,errors:{default:{password:"Too short"}}})));case 25:f.password=u.a.createHmac("sha512",p.secret).update(o.default.password).digest("hex");case 26:if(!o.id){r.next=32;break}return r.next=29,this.mongo.db.collection("users").findOne({_id:new m.ObjectId(o.id)});case 29:if(r.sent){r.next=32;break}return r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:400,errors:{default:{username:"User not found"}}})));case 32:return g={username:o.default.username},o.id&&(g._id={$ne:new m.ObjectId(o.id)}),r.next=36,this.mongo.db.collection("users").findOne(g);case 36:if(!r.sent){r.next=39;break}return r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:400,errors:{default:{username:"Duplicate username"}}})));case 39:return y={email:o.default.email},o.id&&(y._id={$ne:new m.ObjectId(o.id)}),r.next=43,this.mongo.db.collection("users").findOne(y);case 43:if(!r.sent){r.next=46;break}return r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:400,errors:{default:{email:"Duplicate e-mail"}}})));case 46:return r.next=48,this.mongo.db.collection("users").updateOne(o.id?{_id:new m.ObjectId(o.id)}:{username:o.default.username},{$set:S({username:o.default.username,email:o.default.email,active:o.default.active,admin:o.default.admin},f)},{upsert:!0});case 48:if((h=r.sent)&&h.result&&h.result.ok){r.next=51;break}return r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:400,error:"Cannot update database record"})));case 51:return r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:200})));case 54:return r.prev=54,r.t0=r.catch(3),t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:r.t0}),r.abrupt("return",a.code(500).send(JSON.stringify({statusCode:500,error:"Internal server error",message:r.t0.message})));case 58:case"end":return r.stop()}}),r,this,[[3,54]])}))),function(e,t){return r.apply(this,arguments)})};var r}(e)),e.post("/api/users/delete",function(e){return{schema:{body:{type:"object",properties:{token:{type:"string"},ids:{type:"array",minItems:1,contains:{type:"string",minLength:24,maxLength:24,pattern:"^[a-f0-9]+$"}}},required:["token","ids"]}},attachValidation:!0,handler:(r=i()(n.a.mark((function r(t,a){var o,i,s;return n.a.wrap((function(r){for(;;)switch(r.prev=r.next){case 0:if(!t.validationError){r.next=3;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:t.validationError.message}),r.abrupt("return",a.code(400).send(JSON.stringify(t.validationError)));case 3:return r.next=5,l.a.verifyToken(t.body.token,e,this.mongo.db);case 5:if((o=r.sent)&&o.admin){r.next=9;break}return t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:"Authentication failed"}),r.abrupt("return",a.code(403).send(JSON.stringify({statusCode:403,error:"Authentication failed"})));case 9:return r.prev=9,i=t.body.ids.map((function(e){return{_id:new m.ObjectId(e)}})),r.next=13,this.mongo.db.collection("users").deleteMany({$or:i});case 13:if((s=r.sent)&&s.result&&s.result.ok){r.next=16;break}return r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:400,error:"Cannot delete database record(s)"})));case 16:return r.abrupt("return",a.code(200).send(JSON.stringify({statusCode:200})));case 19:return r.prev=19,r.t0=r.catch(9),t.log.error({ip:t.ip,path:t.urlData().path,query:t.urlData().query,error:r.t0}),r.abrupt("return",a.code(500).send(JSON.stringify({statusCode:500,error:"Internal server error",message:r.t0.message})));case 23:case"end":return r.stop()}}),r,this,[[9,19]])}))),function(e,t){return r.apply(this,arguments)})};var r}(e))}},function(e,r,t){"use strict";t.r(r);var a=t(0),n=t.n(a),o=t(1),i=t.n(o),s=t(4),u=t(6),d=t.n(u),c=d()({level:s.loglevel}),p=t(11),l=t.n(p),f=t(12),g=t.n(f),y=t(13),h=t.n(y),m=t(14),b=t.n(m),v=t(15),x=t.n(v),O=t(16),k=t.n(O),q=t(17),S=t(3),D=t(18),N=t.n(D),w=d()({level:s.loglevel}),C=N()({logger:c,trustProxy:s.trustProxy});i()(n.a.mark((function e(){var r;return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return r=new S.MongoClient(s.mongo.url,{useNewUrlParser:!0,useUnifiedTopology:!0}),e.next=3,r.connect();case 3:return C.register(x.a),C.register(k.a,{addToBody:!0}),C.register(g.a),C.register(l.a,{client:r,database:s.mongo.dbName}).register((function(e,r,t){e.mongo.client.db(s.mongo.dbName).on("close",(function(){w.error("Connection to MongoDB is broken"),process.exit(1)})),t()})),C.register(h.a,{origin:s.originCORS}),C.register(b.a,{secret:s.secret}),e.next=11,Promise.all(Object.keys(q).map(function(){var e=i()(n.a.mark((function e(r){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.next=2,t(21)("./".concat(r,"/api/index.js"));case 2:e.sent.default(C);case 4:case"end":return e.stop()}}),e)})));return function(r){return e.apply(this,arguments)}}()));case 11:w.info("Starting API server..."),C.listen(s.apiServer.port,s.apiServer.ip);case 13:case"end":return e.stop()}}),e)})))().catch((function(e){w.error(e),process.exit(1)}))},function(e,r,t){"use strict";t.r(r);var a=t(0),n=t.n(a),o=t(1),i=t.n(o),s=t(5),u=t.n(s).a.readJSONSync("".concat(__dirname,"/../etc/config.json"));r.default=function(e){var r;e.post("/api/config/load",{handler:(r=i()(n.a.mark((function e(r,t){return n.a.wrap((function(e){for(;;)switch(e.prev=e.next){case 0:return e.prev=0,e.abrupt("return",t.code(200).send(JSON.stringify({statusCode:200,config:u})));case 4:return e.prev=4,e.t0=e.catch(0),r.log.error({ip:r.ip,path:r.urlData().path,query:r.urlData().query,error:e.t0}),e.abrupt("return",t.code(500).send(JSON.stringify({statusCode:500,error:"Internal server error",message:e.t0.message})));case 8:case"end":return e.stop()}}),e,null,[[0,4]])}))),function(e,t){return r.apply(this,arguments)})})}}]);