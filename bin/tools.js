!function(e){var n={};function a(o){if(n[o])return n[o].exports;var t=n[o]={i:o,l:!1,exports:{}};return e[o].call(t.exports,t,t.exports,a),t.l=!0,t.exports}a.m=e,a.c=n,a.d=function(e,n,o){a.o(e,n)||Object.defineProperty(e,n,{enumerable:!0,get:o})},a.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},a.t=function(e,n){if(1&n&&(e=a(e)),8&n)return e;if(4&n&&"object"==typeof e&&e&&e.__esModule)return e;var o=Object.create(null);if(a.r(o),Object.defineProperty(o,"default",{enumerable:!0,value:e}),2&n&&"string"!=typeof e)for(var t in e)a.d(o,t,function(n){return e[n]}.bind(null,t));return o},a.n=function(e){var n=e&&e.__esModule?function(){return e.default}:function(){return e};return a.d(n,"a",n),n},a.o=function(e,n){return Object.prototype.hasOwnProperty.call(e,n)},a.p="",a(a.s=15)}([function(e,n){e.exports=require("colors/safe")},function(e,n){e.exports=require("fs-extra")},function(e,n){e.exports=require("@babel/runtime/regenerator")},function(e,n){e.exports=require("@babel/runtime/helpers/asyncToGenerator")},function(e,n){e.exports=require("gettext-parser")},function(e,n){e.exports=require("colors")},function(e){e.exports=JSON.parse('{"admin":{"id":"admin","icon":"","admin":false,"adminRoute":"/admin/users"},"pages":{"id":"pages","icon":"file-text","admin":true,"adminRoute":"/admin/pages"},"users":{"id":"users","icon":"users","admin":true,"adminRoute":"/admin/users"}}')},function(e){e.exports=JSON.parse('{"secret":"79a947c3cbecfb5819b03f21eb00b3180e649bea0c189a7f4ff0bdd10e1fd292","authTokenExpiresIn":"7 days","cookieOptions":{"expires":14,"path":"/","domain":"","secure":false,"sameSite":"strict"},"mongo":{"url":"mongodb://localhost:27017","dbName":"zoia"},"originCORS":"*","trustProxy":true}')},function(e,n){e.exports=require("@babel/runtime/helpers/toConsumableArray")},function(e,n){e.exports=require("@babel/runtime/helpers/slicedToArray")},function(e,n){e.exports=require("inquirer")},function(e,n){e.exports=require("command-line-args")},function(e,n){e.exports=require("lodash/cloneDeep")},function(e,n){e.exports=require("mongodb")},function(e,n){e.exports=require("crypto")},function(e,n,a){"use strict";a.r(n);var o,t,c=a(2),r=a.n(c),s=a(8),i=a.n(s),l=a(3),u=a.n(l),d=a(9),p=a.n(d),m=a(10),f=a.n(m),g=a(11),b=a.n(g),x=a(0),h=a.n(x),v=a(1),y=a.n(v),_=a(4),O=a.n(_),k=a(12),S=a.n(k),j=a(13),w=[{name:"install",alias:"i",type:Boolean},{name:"modify",alias:"m",type:Boolean},{name:"split",alias:"s",type:Boolean},{name:"combine",alias:"c",type:Boolean},{name:"cleanup",alias:"d",type:Boolean}],P=b()(w),q=function(){var e=u()(r.a.mark(function e(){var n,t,c,s,l;return r.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return n=a(7),t=Object.keys(a(6)),c=[{type:"rawlist",name:"install",message:"Which modules to process?",choices:["All","None"].concat(i()(t)),default:"All"}],e.prev=3,console.log("This tool will run the module installation scripts."),console.log("Modules available: ".concat(t.join(", "))),console.log(""),e.next=9,f.a.prompt(c);case 9:return s=e.sent,console.log(""),l=new j.MongoClient(n.mongo.url,{useNewUrlParser:!0,useUnifiedTopology:!0}),e.next=14,l.connect();case 14:if(o=l.db(n.mongo.dbName),"None"===s.install){e.next=18;break}return e.next=18,Promise.all(("All"===s.install?t:[s.install]).map(function(){var e=u()(r.a.mark(function e(n){var t,c,s;return r.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:if(console.log("".concat(h.a.green(" * ")," Processing module: ").concat(n,"...")),e.prev=1,t=a(16)("./".concat(n,"/database.json")),!(c=Object.keys(t.collections)).length){e.next=7;break}return e.next=7,Promise.all(c.map(function(){var e=u()(r.a.mark(function e(a){var c,s,i,l,u,d;return r.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("".concat(h.a.green(" * ")," Creating collection: ").concat(a,"...")),e.prev=1,e.next=4,o.createCollection(a);case 4:e.next=9;break;case 6:e.prev=6,e.t0=e.catch(1),console.log("".concat(h.a.green(" ! ")," Collection is not created: ").concat(a," (already exists?)"));case 9:if(c=t.collections[a],s=c.indexesAsc,i=c.indexesDesc,l=y.a.readdirSync("".concat(__dirname,"/../shared/locales/combined/admin")).filter(function(e){return"_build"!==e}),!s||!s.length){e.next=25;break}return console.log("".concat(h.a.green(" * ")," Creating ASC indexes for collection: ").concat(a,"...")),u={},s.map(function(e){e.match(/\[language\]/i)?l.map(function(n){var a=e.replace(/\[language\]/i,n);u[a]=1}):u[e]=1}),e.prev=15,e.next=18,o.collection(a).createIndex(u,{name:"".concat(n,"_asc")});case 18:e.next=25;break;case 20:e.prev=20,e.t1=e.catch(15),console.log(""),console.log(h.a.red(e.t1)),process.exit(1);case 25:if(!i||!i.length){e.next=39;break}return console.log("".concat(h.a.green(" * ")," Creating DESC indexes for collection: ").concat(a,"...")),d={},i.map(function(e){e.match(/\[language\]/i)?l.map(function(n){var a=e.replace(/\[language\]/i,n);d[a]=-1}):d[e]=-1}),e.prev=29,e.next=32,o.collection(a).createIndex(d,{name:"".concat(n,"_desc")});case 32:e.next=39;break;case 34:e.prev=34,e.t2=e.catch(29),console.log(""),console.log(h.a.red(e.t2)),process.exit(1);case 39:case"end":return e.stop()}},e,null,[[1,6],[15,20],[29,34]])}));return function(n){return e.apply(this,arguments)}}()));case 7:e.next=11;break;case 9:e.prev=9,e.t0=e.catch(1);case 11:return e.prev=11,console.log("".concat(h.a.green(" * ")," Running installation script for module: ").concat(n,"...")),s=a(19)("./".concat(n,"/install.js")),e.next=16,s.default(o);case 16:e.next=20;break;case 18:e.prev=18,e.t1=e.catch(11);case 20:case"end":return e.stop()}},e,null,[[1,9],[11,18]])}));return function(n){return e.apply(this,arguments)}}()));case 18:console.log("".concat(h.a.green(" * ")," Done")),l.close(),e.next=27;break;case 22:e.prev=22,e.t0=e.catch(3),console.log(""),console.log(h.a.red(e.t0)),process.exit(1);case 27:case"end":return e.stop()}},e,null,[[3,22]])}));return function(){return e.apply(this,arguments)}}();console.log(h.a.green.inverse("\n                                      ")),console.log(h.a.green.inverse(" Zoia 2 Helper Scripts                ")),console.log(h.a.green.inverse("                                      \n")),P.split&&(console.log("".concat(h.a.green(" * ")," Spliting locales...")),["user","admin"].map(function(e){console.log("".concat(h.a.green(" * ")," Processing area: ").concat(e)),y.a.readdirSync("".concat(__dirname,"/../shared/locales/combined/").concat(e)).filter(function(e){return"_build"!==e}).map(function(n){console.log("".concat(h.a.green(" * ")," Processing locale: ").concat(n));var a={},o=y.a.readFileSync("".concat(__dirname,"/../shared/locales/combined/").concat(e,"/").concat(n,"/messages.po")),t=O.a.po.parse(o),c=t.translations[""];Object.keys(c).map(function(e){if(e&&e.length&&c[e]&&c[e].comments){var n=c[e].comments.reference;n&&n.split(/\n/).map(function(n){var o=n.split(/\//),t=o.length>=2&&"modules"===o[0]?o[1]:"_core";a[t]||(a[t]={}),a[t][e]=c[e]})}}),Object.keys(a).map(function(o){if("_core"!==o){console.log("".concat(h.a.green(" * ")," Processing module: ").concat(o));var c="_core"===o?"".concat(__dirname,"/../shared/locales/core/").concat(n):"".concat(__dirname,"/../../modules/").concat(o,"/locales/").concat(e,"/").concat(n),r="_core"===o?"".concat(__dirname,"/../shared/locales/core/").concat(n,"/messages.po"):"".concat(__dirname,"/../../modules/").concat(o,"/locales/").concat(e,"/").concat(n,"/messages.po");y.a.ensureDirSync(c);var s=O.a.po.compile({charset:t.charset,headers:t.headers,translations:{"":a[o]}});y.a.writeFileSync(r,s)}})})}),console.log("".concat(h.a.green(" * ")," Done")),process.exit(0)),P.combine&&(t=Object.keys(a(6)),console.log("".concat(h.a.green(" * ")," Combining locales...")),["user","admin"].map(function(e){y.a.readdirSync("".concat(__dirname,"/../shared/locales/core")).filter(function(e){return"_build"!==e}).map(function(n){var a=y.a.readFileSync("".concat(__dirname,"/../shared/locales/core/").concat(n,"/messages.po")),o=O.a.po.parse(a),c=o.translations[""];t.map(function(a){if(y.a.existsSync("".concat(__dirname,"/../../modules/").concat(a,"/locales/").concat(e,"/").concat(n,"/messages.po"))){var o=y.a.readFileSync("".concat(__dirname,"/../../modules/").concat(a,"/locales/").concat(e,"/").concat(n,"/messages.po")),t=O.a.po.parse(o).translations[""];Object.keys(t).map(function(e){c[e]||(c[e]=t[e])})}});var r=O.a.po.compile({charset:o.charset,headers:o.headers,translations:{"":c}});y.a.writeFileSync("".concat(__dirname,"/../shared/locales/combined/").concat(e,"/").concat(n,"/messages.po"),r)})}),console.log("".concat(h.a.green(" * ")," Done")),process.exit(0)),P.cleanup&&(!function(){var e=Object.keys(a(6));console.log("".concat(h.a.green(" * ")," Cleaning up combined locales...")),["user","admin"].map(function(n){console.log("".concat(h.a.green(" * ")," Processing area: ").concat(n)),y.a.readdirSync("".concat(__dirname,"/../shared/locales/combined/").concat(n)).filter(function(e){return"_build"!==e}).map(function(a){console.log("".concat(h.a.green(" * ")," Processing locale: ").concat(a));var o=y.a.readFileSync("".concat(__dirname,"/../shared/locales/combined/").concat(n,"/").concat(a,"/messages.po")),t=O.a.po.parse(o),c=S()(t.translations[""]);Object.keys(c).map(function(n){if(c[n].comments&&c[n].comments.reference){var a=c[n].comments.reference.split(/\n/).filter(function(n){var a=n.split(/\//),o=p()(a,2),t=o[0],c=o[1];return"modules"!==t||!c||-1!==e.indexOf(c)});a.length?t.translations[""][n].comments.reference=a.join(/\n/):delete t.translations[""][n]}});var r=O.a.po.compile({charset:t.charset,headers:t.headers,translations:t.translations});y.a.writeFileSync("".concat(__dirname,"/../shared/locales/combined/").concat(n,"/").concat(a,"/messages.po"),r)})})}(),console.log("".concat(h.a.green(" * ")," Done")),process.exit(0)),P.install?q():console.log("Usage: node tools <--install (--modify)|--split|--combine|--cleanup>\n\n --install (-i): run Zoia installation, use --modify (-m) to modify existing config.json file\n --split (-s): split locales from shared directory to modules\n --combine locales from modules to shared directory\n --cleanup (-d): remove unused locale entries from shared directory")},function(e,n,a){var o={"./pages/database.json":17,"./users/database.json":18};function t(e){var n=c(e);return a(n)}function c(e){if(!a.o(o,e)){var n=new Error("Cannot find module '"+e+"'");throw n.code="MODULE_NOT_FOUND",n}return o[e]}t.keys=function(){return Object.keys(o)},t.resolve=c,e.exports=t,t.id=16},function(e){e.exports=JSON.parse('{"collections":{"pages":{"indexesAsc":["path","filename","data.[language].title"],"indexesDesc":["path","filename","data.[language].title"]}}}')},function(e){e.exports=JSON.parse('{"collections":{"users":{"indexesAsc":["username","password","sessionId","email","active","admin"],"indexesDesc":["username","email","active","admin"]}}}')},function(e,n,a){var o={"./pages/install.js":20,"./users/install.js":21};function t(e){var n=c(e);return a(n)}function c(e){if(!a.o(o,e)){var n=new Error("Cannot find module '"+e+"'");throw n.code="MODULE_NOT_FOUND",n}return o[e]}t.keys=function(){return Object.keys(o)},t.resolve=c,e.exports=t,t.id=19},function(e,n,a){"use strict";a.r(n);var o=a(2),t=a.n(o),c=a(3),r=a.n(c),s=a(5),i=a.n(s),l=function(){var e=r()(t.a.mark(function e(n){return t.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("".concat(i.a.green(" * ")," Inserting or updating default page (/)...")),e.next=3,n.collection("pages").updateOne({path:"/"},{$set:{path:"/",data:{en:{title:"Home Page",content:'Zoia has been installed successfully.<br />Go to <a href="/admin">admin panel</a> to get things done.'},ru:{title:"Главная",content:'Инсталляция Zoia успешно завершена.<br />Вы можете перейти к <a href="/admin">панели администратора</a> для завершения настройки.'}}}},{upsert:!0});case 3:case"end":return e.stop()}},e)}));return function(n){return e.apply(this,arguments)}}();n.default=l},function(e,n,a){"use strict";a.r(n);var o=a(2),t=a.n(o),c=a(3),r=a.n(c),s=a(14),i=a.n(s),l=a(5),u=a.n(l),d=a(7),p=function(){var e=r()(t.a.mark(function e(n){var a;return t.a.wrap(function(e){for(;;)switch(e.prev=e.next){case 0:return console.log("".concat(u.a.green(" * ")," Inserting or updating default user (admin)...")),a=i.a.createHmac("sha512",d.secret).update("password").digest("hex"),e.next=4,n.collection("users").updateOne({username:"admin"},{$set:{username:"admin",password:a,email:"example@zoiajs.org",active:1,admin:1}},{upsert:!0});case 4:case"end":return e.stop()}},e)}));return function(n){return e.apply(this,arguments)}}();n.default=p}]);